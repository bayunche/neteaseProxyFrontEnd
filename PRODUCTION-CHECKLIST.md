# 🚀 生产环境部署检查清单

## 📋 部署前必须完成的项目

### 🔒 安全配置 (Critical)

- [ ] **更新CORS配置**
  ```bash
  # 在 .env.production 中设置你的实际域名
  ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
  ```

- [ ] **SSL证书配置**
  - [ ] 获取有效的SSL证书（推荐Let's Encrypt）
  - [ ] 配置Nginx SSL终止
  - [ ] 强制HTTPS重定向

- [ ] **防火墙设置**
  ```bash
  # 只开放必要端口
  sudo ufw allow 22    # SSH
  sudo ufw allow 80    # HTTP (重定向到HTTPS)
  sudo ufw allow 443   # HTTPS
  sudo ufw deny 3001   # 直接访问代理端口
  ```

- [ ] **容器安全**
  - [ ] 确认以非root用户运行
  - [ ] 更新所有依赖到最新安全版本
  - [ ] 启用Docker安全扫描

### ⚡ 性能优化

- [ ] **服务器规格**
  - [ ] 至少2GB RAM
  - [ ] 至少1CPU核心
  - [ ] 监控磁盘空间（日志增长）

- [ ] **网络优化**
  - [ ] 配置CDN（如有需要）
  - [ ] 优化代理超时时间
  - [ ] 启用压缩

- [ ] **缓存策略**
  - [ ] 图片缓存1小时
  - [ ] 健康检查响应缓存

### 📊 监控和日志

- [ ] **日志管理**
  - [ ] 配置日志轮转
  - [ ] 设置日志级别为INFO
  - [ ] 考虑集中日志收集

- [ ] **监控告警**
  - [ ] 服务可用性监控
  - [ ] 资源使用监控
  - [ ] 错误率告警

- [ ] **健康检查**
  - [ ] 负载均衡器健康检查
  - [ ] 定期端到端测试

## 🛠️ 部署步骤检查

### 1. 环境准备

- [ ] 服务器已安装Docker和Docker Compose
- [ ] 已克隆代码到服务器
- [ ] 已复制并配置 `.env.production`

### 2. 配置验证

- [ ] 验证环境变量正确性
```bash
cat .env.production | grep ALLOWED_ORIGINS
```

- [ ] 测试构建流程
```bash
docker build -f Dockerfile.proxy -t netease-proxy:test .
```

### 3. 部署执行

- [ ] 执行部署脚本
```bash
./deploy-proxy.sh production
```

- [ ] 验证服务启动
```bash
curl http://localhost:3001/health
```

### 4. 功能测试

- [ ] **图片代理测试**
```bash
curl -I "http://localhost:3001/image-proxy?url=http%3A%2F%2Fp2.music.126.net%2FNrUuQGY81gFIxSHqJLEqxQ%3D%3D%2F109951171354669870.jpg"
```

- [ ] **音频代理测试**
```bash
curl -I "http://localhost:3001/audio-proxy?url=<音频URL>"
```

- [ ] **CORS测试**
  - [ ] 从前端域名测试跨域请求
  - [ ] 验证非白名单域名被拒绝

## 🔍 部署后验证

### 立即检查（部署后5分钟内）

- [ ] 服务响应正常
- [ ] 所有端点返回正确状态码
- [ ] 日志无ERROR级别错误
- [ ] 容器资源使用正常

### 短期监控（24小时内）

- [ ] 监控请求成功率 > 99%
- [ ] 平均响应时间 < 500ms
- [ ] 内存使用稳定
- [ ] 无异常重启

### 长期观察（1周内）

- [ ] 日志文件大小可控
- [ ] 定期健康检查通过
- [ ] 性能指标稳定
- [ ] 用户反馈正常

## ⚠️ 风险点和应对方案

### 高风险项目

| 风险 | 影响 | 应对方案 |
|------|------|----------|
| CORS配置错误 | 前端无法访问 | 准备快速回滚，预先测试 |
| 速率限制过严 | 用户体验差 | 逐步调整，监控拒绝率 |
| SSL证书过期 | 服务不可用 | 设置自动续期提醒 |
| 代理服务挂掉 | 音频图片无法加载 | 配置自动重启和告警 |

### 应急预案

- [ ] **回滚计划**: 保留上一版本镜像
- [ ] **紧急联系人**: 确定技术负责人联系方式
- [ ] **备份方案**: 准备备用服务器或CDN

## 📝 部署记录

```
部署日期: ___________
部署人员: ___________
服务器IP: ___________
域名: _______________
SSL证书到期: _______
备注: _______________
```

## ✅ 完成确认

部署负责人签字确认：

- [ ] 我已完成上述所有检查项目
- [ ] 我已测试所有关键功能
- [ ] 我已配置监控和告警
- [ ] 我已准备应急预案

**签字**: ___________  **日期**: ___________

---

⚡ **重要提醒**: 
1. 生产环境部署建议在低峰期进行
2. 部署过程中保持监控面板开启
3. 准备好快速回滚方案
4. 通知相关团队部署时间窗口