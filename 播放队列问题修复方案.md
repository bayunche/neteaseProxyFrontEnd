# æ’­æ”¾é˜Ÿåˆ—æ½œåœ¨é—®é¢˜åˆ†æä¸ä¿®å¤æ–¹æ¡ˆ

## ğŸš¨ å‘ç°çš„å…³é”®é—®é¢˜

### 1. éšæœºæ’­æ”¾æ— é™å¾ªç¯é£é™© (AudioService.ts:485-487)
**é—®é¢˜ä»£ç :**
```typescript
do {
  randomIndex = Math.floor(Math.random() * this.queue.songs.length);
} while (randomIndex === this.queue.currentIndex && this.queue.songs.length > 1);
```

**é£é™©:** å¦‚æœéšæœºæ•°ç”Ÿæˆå™¨æŒç»­è¿”å›ç›¸åŒå€¼ï¼Œä¼šå¯¼è‡´æ— é™å¾ªç¯å¡æ­»ã€‚

**ä¿®å¤æ–¹æ¡ˆ:**
```typescript
async playRandom(): Promise<boolean> {
  if (this.queue.songs.length === 0) return false;
  
  if (this.queue.songs.length === 1) {
    await this.playFromQueue(0);
    return true;
  }
  
  // å®‰å…¨çš„éšæœºé€‰æ‹©ï¼šä»é™¤å½“å‰ç´¢å¼•å¤–çš„æ‰€æœ‰ä½ç½®ä¸­é€‰æ‹©
  const availableIndices = Array.from({ length: this.queue.songs.length }, (_, i) => i)
    .filter(i => i !== this.queue.currentIndex);
  
  if (availableIndices.length === 0) {
    // æç«¯æƒ…å†µï¼šåªæœ‰ä¸€é¦–æ­Œä¸”æ˜¯å½“å‰æ­Œæ›²ï¼Œé‡æ–°æ’­æ”¾
    await this.playFromQueue(this.queue.currentIndex);
  } else {
    const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
    await this.playFromQueue(randomIndex);
  }
  
  return true;
}
```

### 2. æ’­æ”¾ä¸Šä¸€é¦–é€»è¾‘ä¸å®Œæ•´
**é—®é¢˜:** åœ¨åˆ—è¡¨å¾ªç¯æ¨¡å¼ä¸‹ï¼Œæ’­æ”¾ä¸Šä¸€é¦–åˆ°è¾¾å¼€å¤´æ—¶åº”è¯¥è·³åˆ°æœ€åä¸€é¦–ã€‚

**ä¿®å¤æ–¹æ¡ˆ:**
```typescript
async playPrevious(): Promise<boolean> {
  // å¦‚æœå½“å‰æ’­æ”¾æ—¶é—´å¤§äº3ç§’ï¼Œé‡æ–°å¼€å§‹å½“å‰æ­Œæ›²
  if (this.state.currentTime > 3) {
    this.seek(0);
    return true;
  }
  
  const prevIndex = this.queue.currentIndex - 1;
  if (prevIndex >= 0) {
    await this.playFromQueue(prevIndex);
    return true;
  }
  
  // åœ¨åˆ—è¡¨å¾ªç¯æ¨¡å¼ä¸‹ï¼Œä»æœ€åä¸€é¦–å¼€å§‹
  if (this.queue.mode === 'list_loop' && this.queue.songs.length > 0) {
    await this.playFromQueue(this.queue.songs.length - 1);
    return true;
  }
  
  return false;
}
```

### 3. é˜Ÿåˆ—åˆ é™¤åç´¢å¼•å¤„ç†bug
**é—®é¢˜:** åˆ é™¤é˜Ÿåˆ—ä¸­çš„æ­Œæ›²åï¼Œç´¢å¼•å¯èƒ½å˜æˆæ— æ•ˆå€¼ã€‚

**ä¿®å¤æ–¹æ¡ˆ:**
```typescript
removeFromQueue(index: number): void {
  if (index >= 0 && index < this.queue.songs.length) {
    this.queue.songs.splice(index, 1);
    
    if (index < this.queue.currentIndex) {
      this.queue.currentIndex--;
    } else if (index === this.queue.currentIndex) {
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ’­æ”¾çš„æ­Œæ›²
      if (this.queue.songs.length === 0) {
        // é˜Ÿåˆ—ç©ºäº†
        this.queue.currentIndex = -1;
        this.stop();
      } else if (this.queue.currentIndex >= this.queue.songs.length) {
        // ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œè°ƒæ•´åˆ°æœ€åä¸€é¦–
        this.queue.currentIndex = this.queue.songs.length - 1;
      }
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ­Œæ›²ï¼Œå¯èƒ½éœ€è¦åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–
      // è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–çš„é€»è¾‘
    }
    
    this.eventManager.emit('queuechange', this.queue);
  }
}
```

### 4. å†…å­˜æ³„æ¼é£é™©
**é—®é¢˜:** äº‹ä»¶ç›‘å¬å™¨æ²¡æœ‰æ­£ç¡®æ¸…ç†æœºåˆ¶ã€‚

**ä¿®å¤æ–¹æ¡ˆ:**
```typescript
// åœ¨ stores/index.ts ä¸­æ·»åŠ æ¸…ç†é€»è¾‘
const audioStateUnsubscribe = audioService.onStateChange(callback);
const queueChangeUnsubscribe = audioService.on('queuechange', callback);
const queueCompleteUnsubscribe = audioService.on('queuecomplete', callback);

// åœ¨ç»„ä»¶å¸è½½æˆ–storeé”€æ¯æ—¶æ¸…ç†
return () => {
  audioStateUnsubscribe();
  queueChangeUnsubscribe();
  queueCompleteUnsubscribe();
};
```

### 5. æ’­æ”¾æ¨¡å¼åˆ‡æ¢æ—¶çŠ¶æ€ä¸ä¸€è‡´
**é—®é¢˜:** åˆ‡æ¢æ’­æ”¾æ¨¡å¼æ—¶ï¼Œå½“å‰æ’­æ”¾çŠ¶æ€å¯èƒ½ä¸ç¬¦åˆæ–°æ¨¡å¼çš„é€»è¾‘ã€‚

**ä¿®å¤æ–¹æ¡ˆ:**
```typescript
setPlayMode(mode: PlayMode): void {
  const oldMode = this.queue.mode;
  this.queue.mode = mode;
  
  // å¦‚æœä»å•æ›²å¾ªç¯åˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼ï¼Œéœ€è¦è°ƒæ•´æ’­æ”¾è¡Œä¸º
  if (oldMode === 'single' && mode !== 'single') {
    // å¯ä»¥è€ƒè™‘åœæ­¢å½“å‰çš„å•æ›²å¾ªç¯
  }
  
  // æ›´æ–°æ’­æ”¾èƒ½åŠ›çŠ¶æ€
  this.updatePlaybackCapabilities();
  
  this.eventManager.emit('playmodechange', mode);
}
```

### 6. è¾¹ç•Œæƒ…å†µå¤„ç†ä¸å®Œå–„
**é—®é¢˜:** å„ç§è¾¹ç•Œæƒ…å†µæ²¡æœ‰å……åˆ†è€ƒè™‘ã€‚

**è¡¥å……ä¿®å¤:**
```typescript
// æ’­æ”¾é˜Ÿåˆ—ä¸ºç©ºæ—¶çš„å¤„ç†
async play(): Promise<void> {
  if (this.queue.songs.length === 0) {
    console.warn('æ’­æ”¾é˜Ÿåˆ—ä¸ºç©ºï¼Œæ— æ³•æ’­æ”¾');
    this.updateState({ 
      error: 'æ’­æ”¾é˜Ÿåˆ—ä¸ºç©º',
      isPlaying: false,
      isPaused: false 
    });
    return;
  }
  
  // åŸæœ‰é€»è¾‘...
}

// æ’­æ”¾ç´¢å¼•éªŒè¯
async playFromQueue(index: number): Promise<void> {
  if (this.queue.songs.length === 0) {
    console.warn('é˜Ÿåˆ—ä¸ºç©ºï¼Œæ— æ³•æ’­æ”¾');
    return;
  }
  
  if (index < 0 || index >= this.queue.songs.length) {
    console.warn(`æ— æ•ˆçš„é˜Ÿåˆ—ç´¢å¼•: ${index}, é˜Ÿåˆ—é•¿åº¦: ${this.queue.songs.length}`);
    // è‡ªåŠ¨ä¿®æ­£åˆ°æœ‰æ•ˆèŒƒå›´
    index = Math.max(0, Math.min(index, this.queue.songs.length - 1));
  }
  
  this.queue.currentIndex = index;
  this.updateState({ queueCompleted: false });
  this.eventManager.emit('queuechange', this.queue);
  await this.playSong(this.queue.songs[index]);
}
```

## ğŸ¯ é«˜ä¼˜å…ˆçº§ä¿®å¤å»ºè®®

1. **ç«‹å³ä¿®å¤éšæœºæ’­æ”¾æ— é™å¾ªç¯é—®é¢˜** - è¿™æ˜¯æœ€ä¸¥é‡çš„bug
2. **å®Œå–„æ’­æ”¾ä¸Šä¸€é¦–çš„å¾ªç¯é€»è¾‘** - å½±å“ç”¨æˆ·ä½“éªŒ
3. **åŠ å¼ºé˜Ÿåˆ—åˆ é™¤çš„è¾¹ç•Œå¤„ç†** - é˜²æ­¢ç´¢å¼•è¶Šç•Œå´©æºƒ
4. **æ·»åŠ äº‹ä»¶ç›‘å¬å™¨æ¸…ç†æœºåˆ¶** - é˜²æ­¢å†…å­˜æ³„æ¼

## ğŸ” æµ‹è¯•å»ºè®®

### éšæœºæ’­æ”¾æµ‹è¯•
1. åˆ›å»ºåªæœ‰2é¦–æ­Œçš„é˜Ÿåˆ—ï¼Œç–¯ç‹‚ç‚¹å‡»ä¸‹ä¸€é¦–ï¼Œè§‚å¯Ÿæ˜¯å¦å¡æ­»
2. æ’­æ”¾åˆ°æœ€åä¸€é¦–æ—¶åˆ‡æ¢åˆ°éšæœºæ¨¡å¼ï¼Œæµ‹è¯•æ˜¯å¦æ­£å¸¸

### é˜Ÿåˆ—ç®¡ç†æµ‹è¯•
1. æ’­æ”¾ä¸­åˆ é™¤å½“å‰æ­Œæ›²ï¼Œè§‚å¯Ÿæ’­æ”¾çŠ¶æ€
2. åˆ é™¤é˜Ÿåˆ—ä¸­æ‰€æœ‰æ­Œæ›²ï¼Œæµ‹è¯•ç©ºé˜Ÿåˆ—å¤„ç†
3. åœ¨ä¸åŒæ’­æ”¾æ¨¡å¼ä¸‹æµ‹è¯•ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–æŒ‰é’®

### å†…å­˜æ³„æ¼æµ‹è¯•
1. åå¤åˆ‡æ¢é¡µé¢å’Œæ’­æ”¾æ­Œæ›²
2. ä½¿ç”¨æµè§ˆå™¨å¼€å‘å·¥å…·ç›‘æ§å†…å­˜ä½¿ç”¨
3. é•¿æ—¶é—´è¿è¡Œåº”ç”¨è§‚å¯Ÿæ€§èƒ½è¡¨ç°

## ğŸ’¡ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ æ’­æ”¾å†å²è®°å½•** - éšæœºæ’­æ”¾æ—¶é¿å…çŸ­æ—¶é—´å†…é‡å¤æ’­æ”¾åŒä¸€é¦–æ­Œ
2. **å®ç°çœŸæ­£çš„éšæœºç®—æ³•** - è€ƒè™‘ä½¿ç”¨æ´—ç‰Œç®—æ³•è€Œä¸æ˜¯çº¯éšæœº
3. **æ·»åŠ é˜Ÿåˆ—çŠ¶æ€éªŒè¯** - å®šæœŸæ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€çš„ä¸€è‡´æ€§
4. **æ”¹è¿›é”™è¯¯æ¢å¤æœºåˆ¶** - å½“æ’­æ”¾å¤±è´¥æ—¶è‡ªåŠ¨å°è¯•ä¸‹ä¸€é¦–

è¿™äº›é—®é¢˜ä¿®å¤åï¼Œä½ çš„æ’­æ”¾é˜Ÿåˆ—å°†æ›´åŠ ç¨³å®šå’Œç”¨æˆ·å‹å¥½ã€‚