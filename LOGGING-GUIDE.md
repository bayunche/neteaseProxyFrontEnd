# 📝 代理服务器详细日志功能说明

## 🎯 概述

代理服务器现在包含了完整的请求/响应日志记录功能，帮助调试图片和音频代理问题。

## 🔍 日志功能详情

### 1. 请求接收日志
当代理服务器接收到请求时，会打印：
```
🚀 接收请求 [2025-07-25T02:30:00.000Z]
📋 GET /image-proxy?url=https%3A%2F%2Fp1.music.126.net%2F...
🌐 客户端IP: 192.168.1.100
🔗 来源: http://localhost:5173
🖥️  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)...
📎 代理目标: https://p1.music.126.net/109951168428844500/109951168428844500.jpg
────────────────────────────────────────────────────────────────
```

### 2. 代理请求详情
发送代理请求时会显示：
```
==================== 图片代理请求开始 ====================
🔗 原始URL: https://p1.music.126.net/109951168428844500/109951168428844500.jpg
🎯 目标URL: https://p1.music.126.net/109951168428844500/109951168428844500.jpg
📋 请求方法: GET
🏠 目标主机: p1.music.126.net
📂 目标路径: /109951168428844500/109951168428844500.jpg
🌐 客户端IP: 192.168.1.100
🔧 请求头:
     referer: https://music.163.com/
     user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)...
     accept: image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8
     accept-language: zh-CN,zh;q=0.9,en;q=0.8
     cache-control: no-cache
===============================================================
```

### 3. 代理响应信息
收到响应时会记录：
```
==================== 图片代理响应开始 ====================
🔗 原始URL: https://p1.music.126.net/109951168428844500/109951168428844500.jpg
🎯 目标URL: https://p1.music.126.net/109951168428844500/109951168428844500.jpg
📊 响应状态: 404 Not Found
📦 内容类型: application/xml
📏 内容长度: 213
⏱️  响应时间: 2025-07-25T02:30:01.000Z
🔧 重要响应头:
     content-type: application/xml
     content-length: 213
     cache-control: max-age=31536000
     server: Tengine
❌ 错误状态码: 404
❌ 所有响应头: {详细响应头JSON}
✅ CORS头已设置完成
===============================================================
```

### 4. 错误处理详情
出现错误时会显示：
```
==================== 图片代理错误 ====================
🔗 原始URL: https://invalid.domain.com/image.jpg
❌ 错误类型: Error
❌ 错误消息: getaddrinfo ENOTFOUND invalid.domain.com
❌ 错误代码: ENOTFOUND
🌐 客户端IP: 192.168.1.100
⏱️  错误时间: 2025-07-25T02:30:02.000Z
🔍 错误分析: DNS解析失败 - 目标域名不存在
===============================================================
```

## 🛠️ 部署日志增强功能

### 1. 更新服务器代码
```bash
# 在服务器上执行
cd /path/to/audio-proxy
git pull origin master
docker-compose down
docker-compose up --build -d
```

### 2. 查看日志
```bash
# 实时查看日志
docker-compose logs -f audio-proxy

# 查看最近100行日志
docker-compose logs --tail=100 audio-proxy
```

### 3. 测试日志功能
```bash
# 在audio-proxy目录中运行测试脚本
node test-logging.js
```

## 🎯 日志分析

### 成功请求的日志模式
1. 接收请求日志 → 
2. 代理请求开始 → 
3. 代理响应（状态码200） → 
4. CORS头设置完成

### 失败请求的日志模式
1. 接收请求日志 → 
2. 代理请求开始 → 
3. 代理响应（状态码4xx/5xx）或错误日志 → 
4. 错误分析和解释

## 🔍 常见错误类型和分析

| 错误代码 | 错误分析 | 可能原因 |
|---------|---------|---------|
| ENOTFOUND | DNS解析失败 | 域名不存在或DNS配置错误 |
| ECONNREFUSED | 连接被拒绝 | 目标服务器拒绝连接或端口未开放 |
| ETIMEDOUT | 连接超时 | 网络延迟或目标服务器响应慢 |
| ECONNRESET | 连接重置 | 目标服务器主动断开连接 |
| 404 | 资源不存在 | 目标URL对应的资源不存在 |
| 403 | 访问被禁止 | 目标服务器拒绝访问请求 |

## 📊 性能监控

日志中包含的性能指标：
- 请求接收时间
- 代理请求发送时间  
- 响应接收时间
- 内容大小信息
- 请求处理总时长

## 🔧 故障排除

### 1. 如果看不到详细日志
- 确认服务器已更新到最新版本
- 检查日志级别设置
- 确认docker-compose logs命令正确

### 2. 如果日志过多
- 可以通过修改logger配置来调整日志级别
- 使用grep过滤特定类型的日志
- 定期清理日志文件

### 3. 分析特定问题
- 搜索特定URL的所有相关日志
- 查看错误代码和分析信息
- 对比成功和失败请求的差异

## 📞 技术支持

如果需要进一步的日志分析帮助：
1. 收集相关的日志片段
2. 注明具体的问题描述
3. 提供复现步骤
4. 提交到GitHub Issues

这些详细的日志将大大帮助我们快速定位和解决代理问题！